{"ast":null,"code":"\"use strict\";\n\nvar utils = require(\"./utils\");\n\nmodule.exports = function batchProcessorMaker(options) {\n  options = options || {};\n  var reporter = options.reporter;\n  var asyncProcess = utils.getOption(options, \"async\", true);\n  var autoProcess = utils.getOption(options, \"auto\", true);\n\n  if (autoProcess && !asyncProcess) {\n    reporter && reporter.warn(\"Invalid options combination. auto=true and async=false is invalid. Setting async=true.\");\n    asyncProcess = true;\n  }\n\n  var batch = Batch();\n  var asyncFrameHandler;\n  var isProcessing = false;\n\n  function addFunction(level, fn) {\n    if (!isProcessing && autoProcess && asyncProcess && batch.size() === 0) {\n      // Since this is async, it is guaranteed to be executed after that the fn is added to the batch.\n      // This needs to be done before, since we're checking the size of the batch to be 0.\n      processBatchAsync();\n    }\n\n    batch.add(level, fn);\n  }\n\n  function processBatch() {\n    // Save the current batch, and create a new batch so that incoming functions are not added into the currently processing batch.\n    // Continue processing until the top-level batch is empty (functions may be added to the new batch while processing, and so on).\n    isProcessing = true;\n\n    while (batch.size()) {\n      var processingBatch = batch;\n      batch = Batch();\n      processingBatch.process();\n    }\n\n    isProcessing = false;\n  }\n\n  function forceProcessBatch(localAsyncProcess) {\n    if (isProcessing) {\n      return;\n    }\n\n    if (localAsyncProcess === undefined) {\n      localAsyncProcess = asyncProcess;\n    }\n\n    if (asyncFrameHandler) {\n      cancelFrame(asyncFrameHandler);\n      asyncFrameHandler = null;\n    }\n\n    if (localAsyncProcess) {\n      processBatchAsync();\n    } else {\n      processBatch();\n    }\n  }\n\n  function processBatchAsync() {\n    asyncFrameHandler = requestFrame(processBatch);\n  }\n\n  function clearBatch() {\n    batch = {};\n    batchSize = 0;\n    topLevel = 0;\n    bottomLevel = 0;\n  }\n\n  function cancelFrame(listener) {\n    // var cancel = window.cancelAnimationFrame || window.mozCancelAnimationFrame || window.webkitCancelAnimationFrame || window.clearTimeout;\n    var cancel = clearTimeout;\n    return cancel(listener);\n  }\n\n  function requestFrame(callback) {\n    // var raf = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || function(fn) { return window.setTimeout(fn, 20); };\n    var raf = function (fn) {\n      return setTimeout(fn, 0);\n    };\n\n    return raf(callback);\n  }\n\n  return {\n    add: addFunction,\n    force: forceProcessBatch\n  };\n};\n\nfunction Batch() {\n  var batch = {};\n  var size = 0;\n  var topLevel = 0;\n  var bottomLevel = 0;\n\n  function add(level, fn) {\n    if (!fn) {\n      fn = level;\n      level = 0;\n    }\n\n    if (level > topLevel) {\n      topLevel = level;\n    } else if (level < bottomLevel) {\n      bottomLevel = level;\n    }\n\n    if (!batch[level]) {\n      batch[level] = [];\n    }\n\n    batch[level].push(fn);\n    size++;\n  }\n\n  function process() {\n    for (var level = bottomLevel; level <= topLevel; level++) {\n      var fns = batch[level];\n\n      for (var i = 0; i < fns.length; i++) {\n        var fn = fns[i];\n        fn();\n      }\n    }\n  }\n\n  function getSize() {\n    return size;\n  }\n\n  return {\n    add: add,\n    process: process,\n    size: getSize\n  };\n}","map":{"version":3,"sources":["I:/github/pink/node_modules/batch-processor/src/batch-processor.js"],"names":["utils","require","module","exports","batchProcessorMaker","options","reporter","asyncProcess","getOption","autoProcess","warn","batch","Batch","asyncFrameHandler","isProcessing","addFunction","level","fn","size","processBatchAsync","add","processBatch","processingBatch","process","forceProcessBatch","localAsyncProcess","undefined","cancelFrame","requestFrame","clearBatch","batchSize","topLevel","bottomLevel","listener","cancel","clearTimeout","callback","raf","setTimeout","force","push","fns","i","length","getSize"],"mappings":"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","sourcesContent":["\"use strict\";\r\n\r\nvar utils = require(\"./utils\");\r\n\r\nmodule.exports = function batchProcessorMaker(options) {\r\n    options             = options || {};\r\n    var reporter        = options.reporter;\r\n    var asyncProcess    = utils.getOption(options, \"async\", true);\r\n    var autoProcess     = utils.getOption(options, \"auto\", true);\r\n\r\n    if(autoProcess && !asyncProcess) {\r\n        reporter && reporter.warn(\"Invalid options combination. auto=true and async=false is invalid. Setting async=true.\");\r\n        asyncProcess = true;\r\n    }\r\n\r\n    var batch = Batch();\r\n    var asyncFrameHandler;\r\n    var isProcessing = false;\r\n\r\n    function addFunction(level, fn) {\r\n        if(!isProcessing && autoProcess && asyncProcess && batch.size() === 0) {\r\n            // Since this is async, it is guaranteed to be executed after that the fn is added to the batch.\r\n            // This needs to be done before, since we're checking the size of the batch to be 0.\r\n            processBatchAsync();\r\n        }\r\n\r\n        batch.add(level, fn);\r\n    }\r\n\r\n    function processBatch() {\r\n        // Save the current batch, and create a new batch so that incoming functions are not added into the currently processing batch.\r\n        // Continue processing until the top-level batch is empty (functions may be added to the new batch while processing, and so on).\r\n        isProcessing = true;\r\n        while (batch.size()) {\r\n            var processingBatch = batch;\r\n            batch = Batch();\r\n            processingBatch.process();\r\n        }\r\n        isProcessing = false;\r\n    }\r\n\r\n    function forceProcessBatch(localAsyncProcess) {\r\n        if (isProcessing) {\r\n            return;\r\n        }\r\n\r\n        if(localAsyncProcess === undefined) {\r\n            localAsyncProcess = asyncProcess;\r\n        }\r\n\r\n        if(asyncFrameHandler) {\r\n            cancelFrame(asyncFrameHandler);\r\n            asyncFrameHandler = null;\r\n        }\r\n\r\n        if(localAsyncProcess) {\r\n            processBatchAsync();\r\n        } else {\r\n            processBatch();\r\n        }\r\n    }\r\n\r\n    function processBatchAsync() {\r\n        asyncFrameHandler = requestFrame(processBatch);\r\n    }\r\n\r\n    function clearBatch() {\r\n        batch           = {};\r\n        batchSize       = 0;\r\n        topLevel        = 0;\r\n        bottomLevel     = 0;\r\n    }\r\n\r\n    function cancelFrame(listener) {\r\n        // var cancel = window.cancelAnimationFrame || window.mozCancelAnimationFrame || window.webkitCancelAnimationFrame || window.clearTimeout;\r\n        var cancel = clearTimeout;\r\n        return cancel(listener);\r\n    }\r\n\r\n    function requestFrame(callback) {\r\n        // var raf = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || function(fn) { return window.setTimeout(fn, 20); };\r\n        var raf = function(fn) { return setTimeout(fn, 0); };\r\n        return raf(callback);\r\n    }\r\n\r\n    return {\r\n        add: addFunction,\r\n        force: forceProcessBatch\r\n    };\r\n};\r\n\r\nfunction Batch() {\r\n    var batch       = {};\r\n    var size        = 0;\r\n    var topLevel    = 0;\r\n    var bottomLevel = 0;\r\n\r\n    function add(level, fn) {\r\n        if(!fn) {\r\n            fn = level;\r\n            level = 0;\r\n        }\r\n\r\n        if(level > topLevel) {\r\n            topLevel = level;\r\n        } else if(level < bottomLevel) {\r\n            bottomLevel = level;\r\n        }\r\n\r\n        if(!batch[level]) {\r\n            batch[level] = [];\r\n        }\r\n\r\n        batch[level].push(fn);\r\n        size++;\r\n    }\r\n\r\n    function process() {\r\n        for(var level = bottomLevel; level <= topLevel; level++) {\r\n            var fns = batch[level];\r\n\r\n            for(var i = 0; i < fns.length; i++) {\r\n                var fn = fns[i];\r\n                fn();\r\n            }\r\n        }\r\n    }\r\n\r\n    function getSize() {\r\n        return size;\r\n    }\r\n\r\n    return {\r\n        add: add,\r\n        process: process,\r\n        size: getSize\r\n    };\r\n}\r\n"]},"metadata":{},"sourceType":"script"}